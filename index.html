<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.31-DEV" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> hshsh&#39;s little site &middot; hshsh&#39;s little site </title>

  
  <link rel="stylesheet" href="http://hshsh.me/css/poole.css">
  <link rel="stylesheet" href="http://hshsh.me/css/syntax.css">
  <link rel="stylesheet" href="http://hshsh.me/css/hyde.css">
  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/default.min.css">
  <link rel="stylesheet" href="http://hshsh.me/css/style.css">

  
  <script type="text/javascript" src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="http://hshsh.me/index.xml" rel="alternate" type="application/rss+xml" title="hshsh&#39;s little site" />
</head>

<body class=" ">

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://hshsh.me/"><h1>hshsh&#39;s little site</h1></a>
      <p class="lead">
       假行僧 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      <li><a href="/post/"><span class="navlink">Blog</span></a></li>
      <li><a href="https://github.com/jxskiss/">@Github</a></li>
    </ul>

    <p>&copy; 2014 - 2017<br>All rights reserved. </p>
  </div>
</div>


<div class="content container">
<div class="posts">

  
  <div class="post">
    <h1 class="post-title">
      <a href="http://hshsh.me/post/2017-10-22-single-file-vue-webpack/">
        单文件 Vue Webpack 配置
      </a>
    </h1>

    <span class="post-date">Sun, Oct 22, 2017</span>

    

<p>在今年的工作中接触到了前端框架 Vue.js 和构建工具 Webpack。虽然没写了几行前端界面代码，
不过对 Webpack 配置倒是花了一些时间学习，整理了一个针对 Vue.js 的单文件 Webpack 配置。
本文通过对配置文件的注释解析分享 Webpack 配置的一些要点。</p>

<p>本文中配置已经整理为一个糅合了 Django、Tornado、Vue.js、Webpack 的 <a href="https://github.com/jxskiss/nice-pyvue-template">Django 项目模板</a>，主要作为学习记录用途。不过在 Django、Tornado 和 Webpack
的工程配置方面都有一些巧妙地处理，作为前后端分离的工程项目模板也是一个很好的开始（我就是这么用的）。欢迎 Star。</p>

<h2 id="配置目标">配置目标</h2>

<ol>
<li>版本：Vue 2.0+、Webpack 2.0+</li>
<li>支持单页面应用和多页面应用</li>
<li>多页面应用，每个应用入口可选指定自己的HTML模板</li>
<li>多页面应用，可以通过环境变量或命令行选项支持构建指定页面</li>
<li>支持本地 devServer，可指定运行端口，指定开发页面</li>
<li>支持 TypeScript，<code>.ts</code> 文件和 Vue.js 单文件组件</li>
</ol>

<h2 id="项目说明">项目说明</h2>

<h3 id="目录结构">目录结构</h3>

<p>该配置是结合后端 Django 开发做的，因此前端文件放在 <code>frontend</code> 子目录中，
同时为了方便使用 <code>apidocjs</code> 编译API文档，<code>package.json</code>、<code>tsconfig.json</code>、
<code>webpack.config.js</code> 等前端配置文件放在项目根目录下。</p>

<p>对 Django 有所了解的同学，看到 <code>apps/</code> 子目录可能会感到奇怪，这里通过修改 <code>manage.py</code> 文件对
<code>startapp</code> 命令打了一个补丁，把所有新建 app 都放置在 <code>apps/</code> 子目录中以维持目录结构清晰。</p>

<pre><code class="language-text">├── frontend/
│   ├── dist/  # 打包发布目录
│   ├── src/
│   │   ├── assets/  # 静态资源
│   │   │   ├── css/
│   │   │   └── images/
│   │   ├── components/  # 页面组件
│   │   │   └── Hello.vue
│   │   ├── pages/  # 页面代码
│   │   │   ├── demoapp/
│   │   │   │   ├── App.vue
│   │   │   │   ├── index.html  # 应用 HTML 模板文件
│   │   │   │   └── index.js
│   │   │   ├── App.vue
│   │   │   ├── index.html  # 缺省 HTML 模板文件
│   │   │   └── index.ts
│   │   ├── plugins/  # 封装插件
│   │   └── utils/  # 通用 Util 代码
│   └── static  # 发布时需要拷贝到 dist 目录的静态文件
├── node_modules/
├── package.json
├── tsconfig.json  # TypeScript 配置
├── webpack.config.js  # Webpack 单文件配置
├── manage.py
├── apps/  # 后端 Django 应用代码
│   ├── app1/
│   └── app2/
└── project_name/  # 后端 Django 项目配置
</code></pre>

<h3 id="npm包依赖">NPM包依赖</h3>

<ol>
<li>Vue.js 2.5+，Vue 2.5 开始改善了和 TypeScript 的集成应用</li>
<li>TypeScript 2.5+，理由同上</li>
</ol>

<h2 id="配置解析">配置解析</h2>

<pre><code class="language-javascript">/* 
 * 配置文件用到的外部工具
 */
const fs = require('fs')
const glob = require('glob')
const path = require('path')
const webpack = require('webpack')
const ExtractTextPlugin = require('extract-text-webpack-plugin')
const HtmlWebpackPlugin = require('html-webpack-plugin')
const CopyWebpackPlugin = require('copy-webpack-plugin')
const FriendlyErrorsPlugin = require('friendly-errors-webpack-plugin')
const OptimizeCSSPlugin = require('optimize-css-assets-webpack-plugin')

/*
 * 配置选项，对应 vue-cli webpack 工程的 config 目录
 * 1. common 是开发和生产环境公用配置
 * 2. build 是生产配置，dev 是开发配置，当重名时，build 和 dev 覆盖 common 配置
 * 3. extraPlugins 针对生产和开发环境配置单独启用的 webpack 插件
 * 4. outputFilename 针对生产和开发环境配置输出文件命名规则
 * 5. get 工具函数针对 NODE_ENV 环境变量从 build 或者 dev 中查询配置，
 *    如果找不到，则从 common 中查询配置
 * 6. 与 vue-cli webpack 工程不同，这里不使用 *.env.js 配置环境变量，
 *    而是在 module.exports 中通过命令行环境变量或命令行选项设置环境变量，
 *    因此把配置写成一个函数确保拿到正确的环境变量 process.env.VAR
 */
function makeBuildConfigs (options) {
  return {
    // build or dev settings take priority over common settings
    // see the &quot;get&quot; method for details
    common: {
      assetsRoot: path.resolve(__dirname, './frontend/dist'),
      assetsSubDirectory: 'static',
      assetsPublicPath: '/'
    },
    build: {
      cssMinimize: true,
      cssSourceMap: true,
      cssExtract: true,
      // 生产环境启用对调试工具友好的 #source-map，设置为 false 禁用 source-map
      devtool: '#source-map',
      // Gzip off by default as many popular static hosts already gzip
      // all static assets for you. Before setting to true, make sure to:
      // `npm install --save-dev compression-webpack-plugin`
      productionGzip: false,
      productionGzipExtensions: ['js', 'css'],
      // 生产环境单独启用的插件
      extraPlugins: [
        // 压缩JS文件
        new webpack.optimize.UglifyJsPlugin({
          compress: {warnings: false},
          sourceMap: true
        }),
        // 合并压缩提取出的CSS文件
        new OptimizeCSSPlugin({cssProcessorOptions: {safe: true}})
      ],
      outputFilename: (ext) =&gt; ext === 'ext'
        ? `[name].[chunkhash:8].[ext]` : `[name].[chunkhash:8].${ext}`
    },
    dev: {
      cssMinimize: false,
      cssSourceMap: false,
      cssExtract: true,
      // 开发环境使用常规的 #cheap-modulel-eval-source-map，编译速度较快
      devtool: '#cheap-module-eval-source-map',
      // 使用环境变量指定的开发服务端口，默认 8080
      port: process.env.PORT || 8080,
      // 如果有需要，可以配置后端API代理
      // https://webpack.github.io/docs/webpack-dev-server.html#proxy
      proxy: {},
      // 开发环境单独启用的插件
      extraPlugins: [
        // 自动重载开发页面
        new webpack.HotModuleReplacementPlugin(),
        new webpack.NoEmitOnErrorsPlugin(),
        new FriendlyErrorsPlugin()
      ],
      // 开发环境编译输出文件不加 hash
      outputFilename: (ext) =&gt; ext === 'ext' ? `[name].[ext]` : `[name].${ext}`
    },
    // _path: 如果配置有嵌套，使用以 &quot;.&quot; 分割的对象路径
    get: function (_path, options = {}) {
      let config = process.env.NODE_ENV === 'production' ? this.build : this.dev
      let properties = _path.split('.')
      let search = (root) =&gt; {
        let value = null
        for (let idx in properties) {
          let parent = value || root
          if (!parent.hasOwnProperty(properties[idx])) {
            break
          } else {
            value = parent[properties[idx]]
          }
        }
        return value
      }
      let value = search(config)
      if (value === null) value = search(this.common)
      return value
    }
  }
}

/*
 * 从 vue-cli webpack 工程中抄来的 style loaders 配置
 */
function cssLoaders (options) {
  options = options || {}

  let cssLoader = {
    loader: 'css-loader',
    options: {
      minimize: options.minimize,
      sourceMap: options.sourceMap
    }
  }

  // generate loader string to be used with extract text plugin
  function generateLoaders (loader, loaderOptions) {
    let loaders = [cssLoader]
    if (loader) {
      loaders.push({
        loader: loader + '-loader',
        options: Object.assign({}, loaderOptions, {
          sourceMap: options.sourceMap
        })
      })
    }

    // Extract CSS when that option is specified
    // (which is the case during production build)
    if (options.extract) {
      return ExtractTextPlugin.extract({
        use: loaders,
        fallback: 'vue-style-loader'
      })
    } else {
      return ['vue-style-loader'].concat(loaders)
    }
  }

  // http://vuejs.github.io/vue-loader/configurations/extract-css.html
  return {
    css: generateLoaders(),
    postcss: generateLoaders(),
    less: generateLoaders('less'),
    sass: generateLoaders('sass', {indentedSyntax: true}),
    scss: generateLoaders('scss'),
    stylus: generateLoaders('stylus'),
    styl: generateLoaders('stylus')
  }
}

// Generate loaders for standalone style files (outside of .vue)
function styleLoaders (options) {
  let output = []
  let loaders = cssLoaders(options)
  for (let extension in loaders) {
    let loader = loaders[extension]
    output.push({
      test: new RegExp('\\.' + extension + '$'),
      use: loader
    })
  }
  return output
}

/*
 * 获取页面列表
 * 1. 根据指定 PAGE 过滤列表，如果有指定则输出指定页面，否则输出全部页面，
 *    src/pages 目录下的根页面，使用文件 basename 过滤，子目录页面使用子目录名称过滤；
 * 2. 返回不包含 &quot;frontend/src/pages/&quot; 和文件后缀的页面列表；
 */

function getPageEntries (globPath) {
  let targetPage = process.env.PAGE
  let entries = {}, paths, basename, pathname, pageIndex
  glob.sync(globPath).forEach(entry =&gt; {
    basename = path.basename(entry, path.extname(entry))
    // node-glob uses forward-slashes only in glob expressions, even on windows
    paths = entry.split('/')
    pageIndex = paths.indexOf('pages') + 1
    if (targetPage) {  // partially build
      if (paths.length === pageIndex + 1) {  // root pages
        if (basename !== targetPage) {
          return
        }
      } else if (paths[pageIndex] !== targetPage) {
        return
      }
    }
    pathname = paths.slice(pageIndex, -1).concat([basename]).join('/')
    entries[pathname] = entry
  })
  return entries
}

// 解析前端文件路径，类似 vue-cli webpack 工程中 resolve 函数。
// 若未传入 target 参数，返回 frontend 目录路径
function resolveFrontend (target) {
  return path.join(__dirname, 'frontend', target || '')
}

// 检查是否 node_modules 模块
function isNodeModule (module) {
  return (
    module.resource &amp;&amp;
    /\.js$/.test(module.resource) &amp;&amp;
    module.resource.indexOf(
      path.join(__dirname, 'node_modules')
    ) === 0
  )
}

/*
 * Webpack 导出配置，通过使用导出函数，环境变量可以通过命令行参数传入:
 * https://webpack.js.org/api/cli/#environment-options
 */

module.exports = (options = {}) =&gt; {
  // 该配置文件不使用 *.env.js 文件，环境变量使用命令行环境变量或命令行选项传入，
  // Windows 平台不支持 &quot;VAR=value command&quot; 这样的调用方式，
  // 网上多见到使用 cross_env 解决这个问题的，个人以为使用命令行选项更简单优雅
  // --env.production
  if (typeof options.production === 'boolean' &amp;&amp; options.production) {
    process.env.NODE_ENV = 'production'
  } else {
    process.env.NODE_ENV = 'development'
  }
  if (options.port) process.env.PORT = options.port  // --env.port=PORT
  if (options.page) process.env.PAGE = options.page  // --env.page=PAGE

  // 环境变量配置完成，生成配置选项
  const buildConfigs = makeBuildConfigs(options)
  // 针对配置选项的工具函数
  const getConfig = (_path) =&gt; buildConfigs.get(_path, options)
  const assetsPath = (_path) =&gt; path.posix.join(getConfig('assetsSubDirectory'), _path)
  const outputFilename = (ext) =&gt; getConfig('outputFilename')(ext)

  // 导出内容
  let exports = {
    context: path.resolve(__dirname),
    // 获取 frontend/src/pages/ 目录下的所有 .js, .ts 入口文件列表
    entry: getPageEntries(resolveFrontend('src/pages/**/*.[jt]s')),
    output: {
      path: getConfig('assetsRoot'),
      // 输出到 $assetsPath/js/ 目录，使用配置选项中的 outputFilename 计算输出文件名
      filename: assetsPath(`js/${outputFilename('js')}`),
      publicPath: getConfig('assetsPublicPath')
    },

    resolve: {
      modules: [resolveFrontend('src'), 'node_modules'],
      // 解析所有 js/typescript/vue/json/css/scss/less 文件
      extensions: ['.js', '.ts', '.vue', '.json', '.css', '.scss', '.less'],
      // 引用别名，方便代码里引入，如：&quot;import Hello from '@/components/Hello'&quot;
      alias: {
        'vue$': 'vue/dist/vue.esm.js',
        '@': resolveFrontend('src'),
        'assets': resolveFrontend('src/assets'),
        'components': resolveFrontend('src/components'),
        'plugins': resolveFrontend('src/plugins'),
        'utils': resolveFrontend('src/utils')
      }
    },

    module: {
      rules: [
        {  // eslint
          test: /\.(js|vue)$/,
          loader: 'eslint-loader',
          enforce: 'pre',
          include: [resolveFrontend('src'), resolveFrontend('test')],
          exclude: /node_modules/,
          options: {
            formatter: require('eslint-friendly-formatter')
          }
        },
        {
          test: /\.vue$/,
          loader: 'vue-loader',
          options: {
            loaders: cssLoaders({
              minimize: getConfig('cssMinimize') || false,
              sourceMap: getConfig('cssSourceMap') || false,
              extract: getConfig('cssExtract') || false
            }),
            // 在模版编译过程中，编译器可以将某些属性，如 src 路径，转换为 require 调用，
            // 以便目标资源可以由 Webpack 处理。
            // 转为 require 调用可以增加构建的灵活性，并减少开发环境和生产环境路径配置不一致可能导致的问题
            transformToRequire: {
              video: 'src',
              source: 'src',
              img: 'src',
              image: 'xlink:href'
            }
          }
        },
        {
          // typescript
          // 注意：如果在 Vue 单文件组件中使用 typescript，entry 文件必须以 .ts 作为后缀
          test: /\.tsx?$/,
          loader: 'ts-loader',
          include: [resolveFrontend('src'), resolveFrontend('test')],
          options: {
            appendTsSuffixTo: [/\.vue$/],
            // set to false to get benefits from static type checking
            // https://www.npmjs.com/package/ts-loader#transpileonly-boolean-defaultfalse
            transpileOnly: true
          }
        },
        {
          test: /\.js$/,
          loader: 'babel-loader',
          include: [resolveFrontend('src'), resolveFrontend('test')],
          exclude: /node_modules/
        },
        {
          test: /\.json$/,
          loader: 'json-loader'
        },
        {
          test: /\.(png|jpe?g|gif|svg)(\?.*)?$/,
          loader: 'url-loader',
          options: {
            limit: 10000,
            name: assetsPath(`img/${outputFilename('ext')}`)
            // a lot of other options can be customized
          }
        },
        {
          test: /\.(woff2?|eot|ttf|otf)(\?.*)?$/,
          loader: 'url-loader',
          options: {
            limit: 10000,
            name: assetsPath(`fonts/${outputFilename('ext')}`)
          }
        }
      ].concat(styleLoaders({
        minimize: getConfig('cssMinimize') || false,
        sourceMap: getConfig('cssSourceMap') || false,
        extract: getConfig('cssExtract') || false
      }))
    },

    // 可选在 HTML 文件中从CDN引入JS库，可以加入 externals 列表减小打包体积
    externals: {},

    // dev 和 build 通用的 webpack 插件
    plugins: [
      // 提取每个页面的样式表到独立的CSS文件
      new ExtractTextPlugin({
        filename: assetsPath(`css/${outputFilename('css')}`)
      }),
      // any required modules inside node_modules are extracted to vendor
      new webpack.optimize.CommonsChunkPlugin({
        name: 'vendor',
        minChunks: function (module, count) {
          return isNodeModule(module)
        }
      }),
      // extract webpack runtime and module manifest to its own file in order to
      // prevent vendor hash from being updated whenever app bundle is updated
      new webpack.optimize.CommonsChunkPlugin({
        name: 'manifest',
        chunks: ['vendor']
      }),
      // 从 frontend/static/ 目录复制文件到构建目录
      new CopyWebpackPlugin([
        {
          from: resolveFrontend('static'),
          to: getConfig('assetsSubDirectory'),
          ignore: ['.*', 'README.*']
        }
      ])
    ].concat(getConfig('extraPlugins') || []),

    devtool: getConfig('devtool') || '#cheap-module-eval-source-map',

    // development server
    devServer: {
      contentBase: resolveFrontend('dist'),
      compress: true,
      historyApiFallback: true,
      hot: true,
      port: buildConfigs.dev.port,
      proxy: buildConfigs.dev.proxy
    }
  }

  /*
   * 为每个 index/main entry 配置 HtmlWebpackPlugin
   * 1. entry 文件使用 index.js, index.ts, main.js, main.ts 为文件名
   * 2. 输出总是以 index.html 作为文件名，保持和源文件对应的目录结构，例如：
   *    src/pages/index.ts =&gt; dist/index.html
   *    src/pages/main.js =&gt; dist/index.html
   *    src/pages/demoapp/index.js =&gt; dist/demoapp/index.html
   * 3. 如果存在，则使用与 entry 文件对应的同名HTML模板文件，否则使用 src/pages/index.html
   */
  for (let pathname in getPageEntries(resolveFrontend('src/pages/**/@(index|main).[jt]s'))) {
    let conf = {
      filename: ((pn) =&gt; {
        // always use index.html as output filename for main or index entry
        if (pn === 'main') return 'index.html'
        if (pn.endsWith('/main')) return `${pn.slice(0, -5)}/index.html`
        return pn + '.html'
      })(pathname),
      template: ((pn) =&gt; {
        // use root index.html as template if page html not exists
        let htmlPath = resolveFrontend(`src/pages/${pn}.html`)
        if (fs.existsSync(htmlPath)) {
          return htmlPath
        }
        return resolveFrontend('src/pages/index.html')
      })(pathname),
      chunks: [pathname, 'vendor', 'manifest'],
      inject: true,   // inject js file
      minify: {       // minify the html file
        removeComments: true,
        collapseWhitespace: true,
        removeAttributeQuotes: true,
        // necessary to consistently work with multiple chunks via CommonsChunkPlugin
        chunksSortMode: 'dependency'
        // more options:
        // https://github.com/kangax/html-minifier#options-quick-reference
      }
    }
    exports.plugins.push(new HtmlWebpackPlugin(conf))
  }

  /*
   * 为独立HTML页面配置 HtmlWebpackPlugin
   * 1. HTML文件不以 index.html, main.html 为文件名
   * 2. 如果存在同名的 js/ts 文件，则注入HTML文件，无则省略
   */
  for (let pathname in getPageEntries(resolveFrontend('src/pages/**/!(index|main).html'))) {
    let conf = {
      filename: pathname + '.html',
      template: resolveFrontend(`src/pages/${pathname}.html`),
      chunks: [pathname, 'vendor', 'manifest'],
      inject: true,
      minify: {
        removeComments: true,
        collapseWhitespace: true,
        removeAttributeQuotes: true,
        chunksSortMode: 'dependency'
      }
    }
    exports.plugins.push(new HtmlWebpackPlugin(conf))
  }

  // 可选项，大部分生产环境的 Web server 都提供了 gzip 压缩的功能，
  // 通常不会在编译阶段执行 gzip 压缩
  if (getConfig('productionGzip')) {
    let extensions = getConfig('productionGzipExtensions')
    if (extensions &amp;&amp; extensions.length &gt; 0) {
      const CompressionWebpackPlugin = require('compression-webpack-plugin')
      let conf = {
        asset: '[path].gz[query]',
        algorithm: 'gzip',
        test: new RegExp(`\\.(${extensions.join('|')})$`),
        threshold: 10240,
        minRatio: 0.8
      }
      exports.plugins.push(new CompressionWebpackPlugin(conf))
    }
  }

  /*
   * 如果在命令行指定 --env.report 参数，则在构建结束后查看打包分析报告：
   * `npm run build -- --env.report`
   */
  if (options.report) {
    const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin
    exports.plugins.push(new BundleAnalyzerPlugin())
  }

  return exports
}
</code></pre>

<h3 id="配合使用的-package-json">配合使用的 package.json</h3>

<pre><code class="language-jsom">{
  &quot;name&quot;: &quot;project_name&quot;,
  &quot;version&quot;: &quot;0.0.1&quot;,
  &quot;description&quot;: &quot;The Awesome Project&quot;,
  &quot;author&quot;: &quot;&quot;,
  &quot;private&quot;: true,
  &quot;scripts&quot;: {
    &quot;apidoc&quot;: &quot;apidoc -o staticfiles/apidoc -f \&quot;.*\\\\.py\&quot;&quot;,
    &quot;clean&quot;: &quot;rm -rf ./frontend/dist/*&quot;,
    &quot;dev&quot;: &quot;webpack-dev-server -d&quot;,
    &quot;watch&quot;: &quot;webpack -d -w&quot;,
    &quot;build&quot;: &quot;npm run clean &amp;&amp; webpack -p --progress --env.production&quot;
  },
  &quot;dependencies&quot;: {
    &quot;axios&quot;: &quot;^0.16.2&quot;,
    &quot;lodash&quot;: &quot;^4.17.4&quot;,
    &quot;moment&quot;: &quot;^2.19.0&quot;,
    &quot;vue&quot;: &quot;^2.5.2&quot;,
    &quot;vue-router&quot;: &quot;^3.0.1&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;apidoc&quot;: &quot;^0.17.6&quot;,
    &quot;autoprefixer&quot;: &quot;^7.1.5&quot;,
    &quot;babel-core&quot;: &quot;^6.26.0&quot;,
    &quot;babel-eslint&quot;: &quot;^8.0.1&quot;,
    &quot;babel-loader&quot;: &quot;^7.1.2&quot;,
    &quot;babel-plugin-transform-runtime&quot;: &quot;^6.22.0&quot;,
    &quot;babel-preset-env&quot;: &quot;^1.3.2&quot;,
    &quot;babel-preset-stage-2&quot;: &quot;^6.22.0&quot;,
    &quot;babel-register&quot;: &quot;^6.22.0&quot;,
    &quot;chalk&quot;: &quot;^2.1.0&quot;,
    &quot;connect-history-api-fallback&quot;: &quot;^1.3.0&quot;,
    &quot;copy-webpack-plugin&quot;: &quot;^4.0.1&quot;,
    &quot;css-loader&quot;: &quot;^0.28.0&quot;,
    &quot;eslint&quot;: &quot;^4.8.0&quot;,
    &quot;eslint-config-standard&quot;: &quot;^10.2.1&quot;,
    &quot;eslint-friendly-formatter&quot;: &quot;^3.0.0&quot;,
    &quot;eslint-loader&quot;: &quot;^1.7.1&quot;,
    &quot;eslint-plugin-html&quot;: &quot;^3.0.0&quot;,
    &quot;eslint-plugin-import&quot;: &quot;^2.7.0&quot;,
    &quot;eslint-plugin-node&quot;: &quot;^5.2.0&quot;,
    &quot;eslint-plugin-promise&quot;: &quot;^3.4.0&quot;,
    &quot;eslint-plugin-standard&quot;: &quot;^3.0.1&quot;,
    &quot;eventsource-polyfill&quot;: &quot;^0.9.6&quot;,
    &quot;express&quot;: &quot;^4.16.2&quot;,
    &quot;extract-text-webpack-plugin&quot;: &quot;^3.0.1&quot;,
    &quot;file-loader&quot;: &quot;^1.1.5&quot;,
    &quot;friendly-errors-webpack-plugin&quot;: &quot;^1.6.1&quot;,
    &quot;html-webpack-plugin&quot;: &quot;^2.30.1&quot;,
    &quot;http-proxy-middleware&quot;: &quot;^0.17.4&quot;,
    &quot;opn&quot;: &quot;^5.1.0&quot;,
    &quot;optimize-css-assets-webpack-plugin&quot;: &quot;^3.2.0&quot;,
    &quot;ora&quot;: &quot;^1.2.0&quot;,
    &quot;rimraf&quot;: &quot;^2.6.0&quot;,
    &quot;semver&quot;: &quot;^5.3.0&quot;,
    &quot;shelljs&quot;: &quot;^0.7.6&quot;,
    &quot;ts-loader&quot;: &quot;^3.0.5&quot;,
    &quot;typescript&quot;: &quot;^2.5.3&quot;,
    &quot;url-loader&quot;: &quot;^0.6.2&quot;,
    &quot;vue-loader&quot;: &quot;^13.3.0&quot;,
    &quot;vue-style-loader&quot;: &quot;^3.0.3&quot;,
    &quot;vue-template-compiler&quot;: &quot;^2.5.2&quot;,
    &quot;webpack&quot;: &quot;^3.6.0&quot;,
    &quot;webpack-bundle-analyzer&quot;: &quot;^2.9.0&quot;,
    &quot;webpack-dev-middleware&quot;: &quot;^1.12.0&quot;,
    &quot;webpack-dev-server&quot;: &quot;^2.9.1&quot;,
    &quot;webpack-hot-middleware&quot;: &quot;^2.19.1&quot;,
    &quot;webpack-merge&quot;: &quot;^4.1.0&quot;
  },
  &quot;engines&quot;: {
    &quot;node&quot;: &quot;&gt;= 4.0.0&quot;,
    &quot;npm&quot;: &quot;&gt;= 3.0.0&quot;
  },
  &quot;browserslist&quot;: [
    &quot;&gt; 1%&quot;,
    &quot;last 2 versions&quot;,
    &quot;not ie &lt;= 8&quot;
  ],
  &quot;apidoc&quot;: {
    &quot;title&quot;: &quot;The API Documentation&quot;,
    &quot;url&quot;: &quot;http://project.example.com/api&quot;,
    &quot;sampleUrl&quot;: &quot;http://localhost:8080/api&quot;
  }
}
</code></pre>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://hshsh.me/post/2017-10-21-consistent-hashing/">
        一致性哈希算法学习笔记
      </a>
    </h1>

    <span class="post-date">Sat, Oct 21, 2017</span>

    <div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>一致性哈希算法（Consistent Hashing）学习笔记。</p>
<p>主要内容从参考资料中摘抄，版权归原作者所有。</p>
<p>参考资料：</p>
<ul>
<li><a href="http://blog.codinglabs.org/articles/consistent-hashing.html">一致性哈希算法及其在分布式系统中的应用</a></li>
<li><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html">深入云存储系统Swift核心组件：Ring实现原理剖析</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="&#20998;&#24067;&#24335;&#32531;&#23384;&#38382;&#39064;">&#20998;&#24067;&#24335;&#32531;&#23384;&#38382;&#39064;<a class="anchor-link" href="#&#20998;&#24067;&#24335;&#32531;&#23384;&#38382;&#39064;">&#182;</a></h2><p>假设我们有一个网站，最近发现随着流量增加，服务器压力越来越大，之前直接读写数据库的方式不太给力了，于是我们想引入 Memcached 作为缓存机制。现在我们一共有三台机器可以作为 Memcached 服务器，如下图所示。</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/1.png" alt=""></p>
<p>很显然，最简单的策略是将每一次 Memcached 请求随机发送到一台 Memcached 服务器，但是这种策略可能会带来两个问题：</p>
<ol>
<li>同一份数据可能被存在不同的机器上而造成数据冗余；</li>
<li>有可能某数据已经被缓存但是访问却没有命中，因为无法保证对相同 key 的访问都被发送到相同的服务器。</li>
</ol>
<p>因此，随机策略无论是时间效率还是空间效率都非常不好。</p>
<p>要解决上述问题需要做到如下一点：<strong>保证对相同 key 的访问会被发送到相同的服务器</strong>。很多方法可以实现这一点，最常用的方法是计算哈希。例如对于每次访问，可以按如下算法计算哈希值：</p>

<pre><code>h = Hash(key) % 3

</code></pre>
<p>其中，Hash 是一个从字符串到正整数的哈希映射函数。这样，如果我们将 Memcached Server 分别编号为 0、1、2，那么就可以根据上述算式和 key 计算出服务器编号 h，然后去访问。</p>
<p>这个方法虽然解决了上面提到的两个问题，但是存在一些其他的问题，如果将上述方法抽象：</p>

<pre><code>h = Hash(key) % N

</code></pre>
<p>这个算式计算每个 key 的请求应该被发送到哪台服务器，其中 N 为服务器的数量，并且服务器按照 0..(N-1) 进行编号。</p>
<p>这个算法的问题在于容错性和扩展性不好。所谓容错性是指当系统中某一个或几个服务器变得不可用时，整个系统是否可以正确高效运行；而扩展性是指当加入新的服务器后，整个系统是否可以正确高效运行。</p>
<p>现在假设有一台服务器宕机了，那么为了填补空缺，要将宕机的服务器从编号列表中移除，后面的服务器按顺序前移一位并将其编号值减一，此时每个 key 就要按 <code>h = Hash(key) % (N-1)</code> 重新计算；同样，如果新增了一台服务器，虽然原有服务器编号不用改变，但是要按 <code>h = Hash(key) % (N+1)</code> 重新计算哈希值。因此系统中一旦有服务器变更，大量的 key 会被重定位到不同有服务器从而造成大量的缓存不命中。而这种情况在分布式系统中是非常糟糕的。</p>
<p>一个设计良好的分布式哈希方案应该具有良好的单调性，即服务节点的增减不会造成大量哈希值重定位。一致性哈希算法就是这样一种哈希方案。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="&#19968;&#33268;&#24615;&#21704;&#24076;&#31639;&#27861;">&#19968;&#33268;&#24615;&#21704;&#24076;&#31639;&#27861;<a class="anchor-link" href="#&#19968;&#33268;&#24615;&#21704;&#24076;&#31639;&#27861;">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="&#31639;&#27861;&#31616;&#36848;">&#31639;&#27861;&#31616;&#36848;<a class="anchor-link" href="#&#31639;&#27861;&#31616;&#36848;">&#182;</a></h3><p>一致性哈希算法（Consistent Hashing）最早在论文《<a href="https://www.cs.princeton.edu/courses/archive/fall09/cos518/papers/chash.pdf">Consistent Hashing and Random Trees: Distributed Caching Protocols for Relieving Hot Spots on the World Wide Web</a>》中被提出。简单来说，一致性哈希将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数 H 的值空间为 0..2<sup>32</sup>-1（即哈希值是一个32位无符号整数），整个哈希空间环如下图：</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/2.png" alt=""></p>
<p>整个空间按顺时针方向组织。0 和 2<sup>32</sup>-1 在零点钟方向重合。</p>
<p>下一步将各个服务器使用哈希函数 H 计算一个哈希，具体可以选择服务器的IP或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置，这里假设将上文中三台服务器使用IP地址哈希后再环空间的位置如下：</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/3.png" alt=""></p>
<p>接下来使用如下算法定位数据访问到相应服务器：将数据 key 使用相同的哈希函数 H 计算出哈希值 h，根据 h 确定此数据在环上的位置，从此位置沿环顺时针“行走”，第一台遇到的服务器就是其应该定位到的服务器。</p>
<p>例如我们有 A、B、C、D 四个数据对象，经过哈希计算后，在环空间的位置如下：</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/4.png" alt=""></p>
<p>根据一致性哈希算法，数据 A 会被定位到 Server 1 上，D 被定为到 Server 2 上，而 B、C 分别被定为到 Server 2 上。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="&#23481;&#38169;&#24615;&#19982;&#21487;&#25193;&#23637;&#24615;&#20998;&#26512;">&#23481;&#38169;&#24615;&#19982;&#21487;&#25193;&#23637;&#24615;&#20998;&#26512;<a class="anchor-link" href="#&#23481;&#38169;&#24615;&#19982;&#21487;&#25193;&#23637;&#24615;&#20998;&#26512;">&#182;</a></h3><p>下面分析一致性哈希算法的容错性和可扩展性。现假设 Server 3 宕机了：</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/5.png" alt=""></p>
<p>可以看到此时 A、B、C 不会受到影响，只有数据 D 被重定位到 Serverr 2。一般的，在一致性哈希算法中，如果一台服务器不可用，则受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿逆时针方向行走遇到的第一台服务器）之间的数据，其他不会受到影响。</p>
<p>考虑可扩展性，如果我们在系统中增加一台服务器 Server 4：</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/6.png" alt=""></p>
<p>此时 A、C、D 不受影响，只有 B 需要重定位到新的 Server 4。一般的，在一致性哈希算法中，如果增加一台服务器，则受影响的数据仅仅是新服务器到其环空间中前一台服务器（即沿逆时针方向行走遇到的第一台服务器）之间的数据，其他不会受到影响。</p>
<p>综上所述，一致性哈希算法对于节点的增减都只需要定位环空间中的一小部分数据，具有较好的容错性和可扩展性。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="&#34394;&#25311;&#33410;&#28857;">&#34394;&#25311;&#33410;&#28857;<a class="anchor-link" href="#&#34394;&#25311;&#33410;&#28857;">&#182;</a></h3><p>一致性哈希算法在服务节点太少时，容易因为节点分布不均匀而造成数据倾斜问题。假如我们系统中有两台服务器，其环分布如下：</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/7.png" alt=""></p>
<p>此时必然造成大量数据集中到 Server 1 上，而只有极少量数据定位到 Server 2 上。为了解决这种数据倾斜问题，一致性哈希算法引入了虚拟节点机制，即对每一个服务器计算多个哈希，每个计算结果位置都放置一个此服务节点，称为虚拟节点。</p>
<p>具体做法可以在服务器IP或主机名的后面增加编号来实现。例如上面的情况，我们决定为每台服务器计算三个虚拟节点，于是可以分别计算 <code>"Memcached Server 1#1"</code>、<code>"Memcached Server 1#2"</code>、<code>"Memcached Server 1#3"</code>、<code>"Memcached Server 2#1"</code>、<code>"Memcached Server 2#2"</code>、<code>"Memcached Server 2#3"</code> 的哈希值，于是形成六个虚拟节点：</p>
<p><img src="http://blog.codinglabs.org/uploads/pictures/consistent-hashing/8.png" alt=""></p>
<p>同时数据定位算法不变，只是多了一步虚拟节点到实际节点的映射，例如定位到 <code>"Memcached Server 1#1"</code>、<code>"Memcached Server 1#2"</code>、<code>"Memcached Server 1#3"</code> 三个虚拟节点的数据均定位到 Server 1 上。这样就解决了服务节点少时数据倾斜的问题。在实际应用中，通常将虚拟节点数设置为32甚至更大，因此即使很少的服务节点也能做到相对均匀的数据分布。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="&#30456;&#20851;&#20998;&#24067;&#24335;&#38382;&#39064;">&#30456;&#20851;&#20998;&#24067;&#24335;&#38382;&#39064;<a class="anchor-link" href="#&#30456;&#20851;&#20998;&#24067;&#24335;&#38382;&#39064;">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="&#33410;&#28857;&#26435;&#37325;">&#33410;&#28857;&#26435;&#37325;<a class="anchor-link" href="#&#33410;&#28857;&#26435;&#37325;">&#182;</a></h3><p>不同的节点处理能力可能不一致，处理能力强大的服务节点可以划分多一些虚拟节点，相应的处理能力较差的服务节点可以划分少一些虚拟节点。</p>
<p>在 OpenStack Swift 中引入了权重（Weight）的概念来做这件事情。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="&#25968;&#25454;&#21103;&#26412;&#65288;Replica&#65289;">&#25968;&#25454;&#21103;&#26412;&#65288;Replica&#65289;<a class="anchor-link" href="#&#25968;&#25454;&#21103;&#26412;&#65288;Replica&#65289;">&#182;</a></h3><p>为了保证数据安全，分布是系统通常会使用冗余副本（Replica）来保证数据安全。</p>
<p>NWR 是一种在分布式存储系统中用于控制一致性级别的一种策略。每个字母的含义如下：</p>
<ul>
<li>N: 同一份数据的 Replica 的份数</li>
<li>W: 更新一个数据对象的时候需要确保成功更新的份数</li>
<li>R: 读取一个数据需要读取的 Replica 的份数</li>
</ul>
<p>在健壮的分布式系统中，数据的单点是不允许存在的。即线上正常存在的 Replica 数量是1的情况是非常危险的，因为一旦这个 Replica 发生错误，就可能发生数据的永久性错误。加入我们把 N 设置成为2，那么只要有一个存储节点发生损坏，就会有单点的存在，所以 N 必须大于2。N 越大，系统的维护和整体成本就越高，工业界通常把副本数量 N 设置为3。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="&#20998;&#21306;&#65288;Zone&#65289;">&#20998;&#21306;&#65288;Zone&#65289;<a class="anchor-link" href="#&#20998;&#21306;&#65288;Zone&#65289;">&#182;</a></h3><p>考虑 CAP 定理中的分区容错性(P)，分布式系统需要一种机制对服务器的物理资源进行隔离。</p>
<p>OpenStack Swift 中引入了 Zone 的概念对服务器进行物理隔离。所有的服务节点被分割到不同的 Zone 中，每个虚拟节点（Partition）的副本（Replica）不能放在同一个 Zone 内。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="&#24635;&#32467;">&#24635;&#32467;<a class="anchor-link" href="#&#24635;&#32467;">&#182;</a></h2><p>目前一致性哈希基本成为了分布式系统组建的标准配置，例如 Memcached 的各种客户端都提供内置的一致性哈希支持。在企业级产品中应用非常广泛，如 Amazon DynamoDB，OpenStack Swift 等。</p>
<p>抄一段测试代码：</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html</span>
<span class="kn">from</span> <span class="nn">array</span> <span class="k">import</span> <span class="n">array</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="k">import</span> <span class="n">unpack_from</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="k">class</span> <span class="nc">Ring</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">part2node</span><span class="p">,</span> <span class="n">relicas</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">part2node</span> <span class="o">=</span> <span class="n">part2node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="n">replicas</span>
        <span class="n">partition_power</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">partition_power</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">part2node</span><span class="p">):</span>
            <span class="n">partition_power</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part2node</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">partition_power</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;part2node length is not an exact power of 2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partition_shift</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="n">partition_power</span>

    <span class="k">def</span> <span class="nf">get_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_id</span><span class="p">):</span>
        <span class="n">data_id</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data_id</span><span class="p">),</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="n">part</span> <span class="o">=</span> <span class="n">unpack_from</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">md5</span><span class="p">(</span><span class="n">data_id</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
                          <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_shift</span>
        <span class="n">node_ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">part2node</span><span class="p">[</span><span class="n">part</span><span class="p">]]</span>
        <span class="n">zones</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
        <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicas</span><span class="p">):</span>
            <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">part2node</span><span class="p">[</span><span class="n">part</span><span class="p">]</span> <span class="ow">in</span> <span class="n">node_ids</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">part2node</span><span class="p">[</span><span class="n">part</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">):</span>
                <span class="n">part</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">part</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">part2node</span><span class="p">):</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">node_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">part2node</span><span class="p">[</span><span class="n">part</span><span class="p">])</span>
            <span class="n">zones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node_ids</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">build_ring</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">partition_power</span><span class="p">,</span> <span class="n">replicas</span><span class="p">):</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">partition_power</span>
    <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">node</span><span class="p">[</span><span class="s1">&#39;desired_parts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span> <span class="o">/</span> <span class="n">total_weight</span> <span class="o">*</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
    <span class="n">part2node</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">partition_power</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;desired_parts&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s1">&#39;desired_parts&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">part2node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;desired_parts&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">node</span><span class="p">[</span><span class="s1">&#39;desired_parts&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">part2node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="k">break</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">part2node</span><span class="p">)</span>
    <span class="n">ring</span> <span class="o">=</span> <span class="n">Ring</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">part2node</span><span class="p">,</span> <span class="n">replicas</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.02f</span><span class="s1">s to build ring&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ring</span>

<span class="k">def</span> <span class="nf">test_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">replicas</span><span class="p">):</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">data_id_count</span> <span class="o">=</span> <span class="mi">10000000</span>
    <span class="n">node_counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">zone_counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">data_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_id_count</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ring</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">(</span><span class="n">data_id</span><span class="p">):</span>
            <span class="n">node_counts</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">node_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">zone_counts</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">zone_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.02f</span><span class="s1">s to test ring&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span><span class="p">))</span>
    
    <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ring</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">max_over</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_under</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ring</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">desired</span> <span class="o">=</span> <span class="n">data_id_count</span> <span class="o">*</span> <span class="n">replicas</span> <span class="o">*</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_weight</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">node_counts</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">desired</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">over</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">desired</span>
            <span class="k">if</span> <span class="n">over</span> <span class="o">&gt;</span> <span class="n">max_over</span><span class="p">:</span>
                <span class="n">max_over</span> <span class="o">=</span> <span class="n">over</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">under</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">desired</span>
            <span class="k">if</span> <span class="n">under</span> <span class="o">&gt;</span> <span class="n">max_under</span><span class="p">:</span>
                <span class="n">max_under</span> <span class="o">=</span> <span class="n">under</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.02f%%</span><span class="s1"> max node over&#39;</span> <span class="o">%</span> <span class="n">max_over</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.02f%%</span><span class="s1"> max node under&#39;</span> <span class="o">%</span> <span class="n">max_under</span><span class="p">)</span>
    
    <span class="n">max_over</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_under</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ring</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">zone_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ring</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                          <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zone</span><span class="p">)</span>
        <span class="n">desired</span> <span class="o">=</span> <span class="n">data_id_count</span> <span class="o">*</span> <span class="n">replicas</span> <span class="o">*</span> <span class="n">zone_weight</span> <span class="o">/</span> <span class="n">total_weight</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">zone_counts</span><span class="p">[</span><span class="n">zone</span><span class="p">]</span> <span class="o">-</span> <span class="n">desired</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">over</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">desired</span>
            <span class="k">if</span> <span class="n">over</span> <span class="o">&gt;</span> <span class="n">max_over</span><span class="p">:</span>
                <span class="n">max_over</span> <span class="o">=</span> <span class="n">over</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">under</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">desired</span>
            <span class="k">if</span> <span class="n">under</span> <span class="o">&gt;</span> <span class="n">max_under</span><span class="p">:</span>
                <span class="n">max_under</span> <span class="o">=</span> <span class="n">under</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.02f%%</span><span class="s1"> max zone over&#39;</span> <span class="o">%</span> <span class="n">max_over</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.02f%%</span><span class="s1"> max zone under&#39;</span> <span class="o">%</span> <span class="n">max_under</span><span class="p">)</span>


<span class="n">partition_power</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">replicas</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">node_count</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">zone_count</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">node_count</span><span class="p">:</span>
    <span class="n">zone</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">zone</span> <span class="o">&lt;</span> <span class="n">zone_count</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">node_count</span><span class="p">:</span>
        <span class="n">node_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="s1">&#39;zone&#39;</span><span class="p">:</span> <span class="n">zone</span><span class="p">,</span>
                          <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">node_id</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)}</span>
        <span class="n">zone</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">ring</span> <span class="o">=</span> <span class="n">build_ring</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">partition_power</span><span class="p">,</span> <span class="n">replicas</span><span class="p">)</span>
<span class="n">test_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">replicas</span><span class="p">)</span>
</pre></div>

<p></div>
</div>
</div></p>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

<div class="output_subarea output_stream output_stdout output_text">
<pre>1.15s to build ring
81.58s to test ring
1.38% max node over
1.67% max node under
0.23% max zone over
0.21% max zone under
</pre>
</div>
</div>

<p></div>
</div></p>

<p></div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<style>
div.prompt.input_prompt {display: none;}
</style>
</div>
</div>
</div></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://hshsh.me/post/2017-06-13-django-admin-ticks/">
        Django Admin 定制开发技巧
      </a>
    </h1>

    <span class="post-date">Tue, Jun 13, 2017</span>

    

<h2 id="过滤器-filters">过滤器（Filters）</h2>

<h3 id="下拉列表式过滤器">下拉列表式过滤器</h3>

<p>模版文件：</p>

<pre><code class="language-html">{% load i18n %}
&lt;script type=&quot;text/javascript&quot;&gt;var go_from_select = function(opt) { window.location = window.location.pathname + opt };&lt;/script&gt;
&lt;h3&gt;{% blocktrans with filter_title=title %} By {{ filter_title }} {% endblocktrans %}&lt;/h3&gt;
&lt;ul class=&quot;admin-filter-{{ title|cut:' ' }}&quot;&gt;
{% if choices|slice:&quot;4:&quot; %}
    &lt;li&gt;
    &lt;select style=&quot;width: 95%;&quot;
        onchange=&quot;go_from_select(this.options[this.selectedIndex].value)&quot;&gt;
    {% for choice in choices %}
        &lt;option{% if choice.selected %} selected=&quot;selected&quot;{% endif %}
         value=&quot;{{ choice.query_string|iriencode }}&quot;&gt;{{ choice.display }}&lt;/option&gt;
    {% endfor %}
    &lt;/select&gt;
    &lt;/li&gt;
{% else %}
    {% for choice in choices %}
        &lt;li{% if choice.selected %} class=&quot;selected&quot;{% endif %}&gt;
        &lt;a href=&quot;{{ choice.query_string|iriencode }}&quot;&gt;{{ choice.display }}&lt;/a&gt;&lt;/li&gt;
    {% endfor %}
{% endif %}
&lt;/ul&gt;
</code></pre>

<p>Admin代码：</p>

<pre><code class="language-python">from django.contrib.admin.filters import (
    AllValuesFieldListFilter, RelatedFieldListFilter, ChoicesFieldListFilter)


class DropdownFilter(AllValuesFieldListFilter):
    template = 'app/admin/dropdown_filter.html'
    

class RelatedDropdownFilter(RelatedFieldListFilter):
    template = 'app/admin/dropdown_filter.html'


class ChoicesDropdownFilter(ChoicesFieldListFilter):
    template = 'app/admin/dropdown_filter.html'
</code></pre>

<h3 id="三级分类级联过滤器">三级分类级联过滤器</h3>

<pre><code class="language-python">from django.db import models
from django.contrib import admin


class Category(models.Model):
    code = models.CharField(verbose_name='分类代码', max_length=6)
    name = models.CharField(verbose_name='分类名', max_length=255)
    level = models.SmallIntegerField(verbose_name='级别')
    lv1_code = models.CharField(verbose_name='一级代码', max_length=2, default='', blank=True)
    lv1_name = models.CharField(verbose_name='一级分类', max_length=255, default='', blank=True)
    lv2_code = models.CharField(verbose_name='二级代码', max_length=4, default='', blank=True)
    lv2_name = models.CharField(verbose_name='二级分类', max_length=255, default='', blank=True)


class Item(models.Model):
    name = models.CharField(verbose_name='商品名', max_length=255)
    category = models.ForeignKey(Category, verbose_name='商品分类', null=True, blank=True)
    cover_img = models.CharField(verbose_name='封面图片', max_length=255, null=True, blank=True)


class CategoryLv1Filter(admin.SimpleListFilter):
    title = '一级分类'
    parameter_name = 'cat_lv1_code__exact'
    template = 'app/admin/dropdown_filter.html'

    def lookups(self, request, model_admin):
        cat_lv1 = Category.objects.filter(level=1)
        return [
            (cat.code, cat.name)
            for cat in cat_lv1
        ]

    def queryset(self, request, queryset):
        cat_lv1 = self.value()
        if cat_lv1:
            queryset = queryset.filter(category__lv1_code=cat_lv1)
        return queryset


class CategoryLv2Filter(admin.SimpleListFilter):
    title = '二级分类'
    parameter_name = 'cat_lv2_code__exact'
    template = 'app/admin/dropdown_filter.html'

    def lookups(self, request, model_admin):
        cat_lv1 = request.GET.get('cat_lv1_code__exact')
        if cat_lv1:
            cat_lv2 = Category.objects.filter(level=2, lv1_code=cat_lv1)
        else:
            cat_lv2 = []
        return [
            (cat.code, cat.name)
            for cat in cat_lv2
        ]

    def queryset(self, request, queryset):
        cat_lv2 = self.value()
        if cat_lv2:
            queryset = queryset.filter(category__lv2_code=cat_lv2)
        return queryset


class CategoryLv3Filter(admin.SimpleListFilter):
    title = '三级分类'
    parameter_name = 'cat_lv3_code__exact'
    template = 'app/admin/dropdown_filter.html'

    def lookups(self, request, model_admin):
        cat_lv1 = request.GET.get('cat_lv1_code__exact')
        cat_lv2 = request.GET.get('cat_lv2_code__exact')
        if cat_lv1 and cat_lv2:
            cat_lv3 = Category.objects.filter(level=3, lv2_code=cat_lv2)
        else:
            cat_lv3 = []
        return [
            (cat.code, cat.name)
            for cat in cat_lv3
        ]

    def queryset(self, request, queryset):
        cat_lv3 = self.value()
        if cat_lv3:
            queryset = queryset.filter(category__code=cat_lv3)
        return queryset


class ItemAdmin(admin.ModelAdmin):
    # ...
    list_filter = [CategoryLv1Filter, CategoryLv2Filter, CategoryLv3Filter]
</code></pre>

<h2 id="对象表单-changelist">对象表单（ChangeList）</h2>

<h3 id="列表中显示图片-链接">列表中显示图片、链接</h3>

<pre><code class="language-python">from django.contrib import admin

_default_image = '/static/images/common/Bmr_160.png'


# define as a standalone function
def cover_img_html(obj):
    img_url = obj.cover_img or _default_image
    return '&lt;img src=&quot;{}&quot; style=&quot;width:100px;height:100px;&quot; /&gt;'.format(img_url)
cover_img_html.allow_tags = True
cover_img_html.short_description = '封面图片'


class ItemAdmin(admin.ModelAdmin):
    list_display = [cover_img_html, 'category_link']

    # define as a method
    def category_link(self, obj):
        if not obj.category:
            return '--'
        return ('&lt;a href=&quot;/admin/app/category/{}&quot; target=&quot;_blank&quot;&gt;{}&lt;/a&gt;'
                .format(obj.category.id, obj.category.name))
    category_link.allow_tags = True
    category_link.short_description = '商品分类'
    category_link.admin_order_field = 'category_id'
</code></pre>

<h3 id="减小外键关联下拉列表选项数量">减小外键关联下拉列表选项数量</h3>

<pre><code class="language-python">from django.db import models
from django.forms import ModelForm
from django.contrib import admin


class Category(models.Model):
    code = models.CharField(verbose_name='分类代码', max_length=6)
    name = models.CharField(verbose_name='分类名', max_length=255)
    level = models.SmallIntegerField(verbose_name='级别')
    lv1_code = models.CharField(verbose_name='一级代码', max_length=2, default='', blank=True)
    lv1_name = models.CharField(verbose_name='一级分类', max_length=255, default='', blank=True)
    lv2_code = models.CharField(verbose_name='二级代码', max_length=4, default='', blank=True)
    lv2_name = models.CharField(verbose_name='二级分类', max_length=255, default='', blank=True)
    
    
class Vendor(models.Model):
    brand = models.CharField(verbose_name='品牌', max_length=255)
    city = models.CharField(verbose_name='城市', max_length=255)
    address = models.CharField(verbose_name='地址', max_length=255)


class Item(models.Model):
    name = models.CharField(verbose_name='商品名', max_length=255)
    brand = models.CharField(verbose_name='品牌', max_length=255)
    vendor = models.ForeignKey(Vendor, verbose_name='生产厂家', null=True, blank=True)
    category = models.ForeignKey(Category, verbose_name='商品分类', null=True, blank=True)
    cover_img = models.CharField(verbose_name='封面图片', max_length=255, null=True, blank=True)


class ItemModelForm(ModelForm):

    def __init__(self, *args, **kwargs):
        super(ItemModelForm, self).__init__(*args, **kwargs)
        if self.instance:
            inst_brand = self.instance.brand
            self.fields['vendor'].queryset = Vendor.objects.filter(brand=inst_brand)


class ItemAdmin(admin.ModelAdmin):
    # ...
    form = ItemModelForm
</code></pre>

<h2 id="批量操作-actions">批量操作（Actions）</h2>

<h3 id="禁用批量删除动作">禁用批量删除动作</h3>

<pre><code class="language-python">from django.contrib import admin


class ItemAdmin(admin.ModelAdmin):
    # ...

    def get_actions(self, request):
        actions = super(ItemAdmin, self).get_actions(request)
        if 'delete_selected' in actions:
            del actions['delete_selected']
        return actions
</code></pre>

<h3 id="批量执行动作">批量执行动作</h3>

<pre><code class="language-python">from django.contrib import messages, admin


def batch_remove_category(model_admin, request, queryset):
    # batch at database level
    queryset.update(category_id=None)

    # # or one by one at orm level
    # for obj in queryset:
    #     obj.category = None
    #     obj.save()

    # messages can be send to the admin page
    messages.success(request, '操作成功！')
batch_remove_category.short_description = '批量删除分类'

    
class ItemAdmin(admin.ModelAdmin):
    # ...
    actions = [batch_remove_category, ]
</code></pre>

<h3 id="需要参数的批量执行动作">需要参数的批量执行动作</h3>

<pre><code class="language-python">from django.forms import CharField
from django.contrib import admin, messages
from django.contrib.admin import helpers, actions


class ChangeBrandActionForm(helpers.ActionForm):
    brand = CharField(max_length=255, required=False)


def batch_change_brand(model_admin, request, queryset):
    brand = request.POST.get('brand')
    if not brand:
        messages.error(request, '请填写非空的品牌名称！')
        return
    queryset.update(brand=brand)
    messages.success(request, '修改成功！')
batch_change_brand.short_description = '批量修改品牌'


class ItemAdmin(admin.ModelAdmin):
    # ...
    actions = [batch_change_brand, ]
    action_form = ChangeBrandActionForm
</code></pre>

<h3 id="动态创建批量动作">动态创建批量动作</h3>

<pre><code class="language-python">from django.db import models
from django.contrib import admin, messages


class ItemABCType(object):
    A = 'A'
    B = 'B'
    C = 'C'
    CHOICES = [
        (A, 'A类商品'),
        (B, 'B类商品'),
        (C, 'C类商品')
    ]


class Item(models.Model):
    abc_type = models.CharField(
        verbose_name='商品评级', max_length=1,
        choices=ItemABCType.CHOICES, null=True, blank=True)


def _make_mark_action(typ, name):
    def mark_action_func(model_admin, request, queryset):
        queryset.update(type=typ)
        messages.success(request, '操作成功！')

    action_name = 'mark_action_func_{}'.format(typ)
    mark_action_func.func_name = action_name
    mark_action_func.short_description = '商品评级：{}'.format(name)
    return mark_action_func


class ItemAdmin(admin.ModelAdmin):
    # ...
    actions = [_make_mark_action(typ, name) for typ, name in ItemABCType.CHOICES]
</code></pre>

<h3 id="对所有行执行指定操作">对所有行执行指定操作</h3>

<p>其他适用场景：批量／全量下载文件，跨库同步。</p>

<pre><code class="language-python">from django.db import models
from django.contrib import admin, messages


class Category(models.Model):
    pinyin = models.TextField(verbose_name='拼音', default='', blank=True)

    def update_pinyin(self):
        pinyin = ''
        self.pinyin = pinyin
        self.save()


def batch_update_pinyin(model_admin, request, queryset):
    count = queryset.count()
    for cat in queryset:
        cat.update_pinyin()
    messages.success(request, '成功更新%d条拼音！' % count)
batch_update_pinyin.short_description = '批量更新分类拼音'


class CategoryAdmin(admin.ModelAdmin):
    # ...
    actions = [batch_update_pinyin, ]
    
    def changelist_view(self, request, extra_context=None):
        &quot;&quot;&quot;
        Override to allow action on all records without selection.
        &quot;&quot;&quot;
        if (request.POST.get('action') == 'batch_update_pinyin' and
                not request.POST.getlist(admin.ACTION_CHECKBOX_NAME)):
            post = request.POST.copy()
            for cat in Category.objects.all():
                post.update({admin.ACTION_CHECKBOX_NAME: str(cat.id)})
            request._set_post(post)
        return super(CategoryAdmin, self).changelist_view(request, extra_context)
</code></pre>

<h2 id="页面交互">页面交互</h2>

<h3 id="对象编辑页面添加特殊字段">对象编辑页面添加特殊字段</h3>

<pre><code class="language-python">from django.forms import ModelForm, CharField
from django.contrib import admin


class ItemAdminForm(ModelForm):

    upload_img_url = CharField(max_length=255, required=False)

    def save(self, commit=True):
        upload_img_url = self.cleaned_data.get('upload_img_url')
        if upload_img_url:
            self.upload_image(upload_img_url)
        return super(ItemAdminForm, self).save(commit)

    def upload_image(self, image_url):
        pass


class ItemAdmin(admin.ModelAdmin):
    # ...
    form = ItemAdminForm
</code></pre>

<h3 id="用js定制复杂交互功能">用JS定制复杂交互功能</h3>

<p>模版文件：</p>

<pre><code class="language-html">{% extends &quot;admin/change_list.html&quot; %}

{% block extrahead %}
{{ block.super }}
&lt;link href=&quot;//cdn.bootcss.com/semantic-ui/2.2.10/semantic.min.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;script src=&quot;//cdn.bootcss.com/jquery/3.1.0/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;//cdn.bootcss.com/semantic-ui/2.2.10/semantic.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;//cdn.bootcss.com/lodash.js/4.17.4/lodash.min.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
$(function () {
  var extraStyles = ' \
        &lt;style type=&quot;text/css&quot;&gt; \
        /* .actions {position: fixed;} */ \
        .field-name input {width: 10em;} \
        .field-brand input, .field-spec input, .field-price input {width: 4em;} \
        input[type=checkbox] {transform: scale(1.4);} \
        .hover-image { \
            display: none; padding: 30px; \
            position: fixed; top: 50%; left: 50%; \
            transform: translate(-50%, -50%); z-index: 1; \
            width: 400px; height: 400px; \
            border: 1px solid #cecece; background: #fff; \
        } \
        &lt;/style&gt;'
  $(extraStyles).appendTo($('head'))
})

window.onload = function () {
  var categoryHTML = ' \
        &lt;div class=&quot;wrap&quot;&gt; \
        &lt;input name=&quot;action_category&quot; type=&quot;text&quot; class=&quot;search&quot;&gt; \
        &lt;div class=&quot;menu&quot;&gt;&lt;/div&gt; \
        &lt;/div&gt;'
  $('.actions input[name=&quot;action_category&quot;]'.replaceWith(categoryHTML))

  var hoverImageHTML = '&lt;img src=&quot;&quot; class=&quot;hover-image&quot;/&gt;'
  $(hoverImageHTML).appendTo($('body'))

  // show image when mouse move over image links
  $('tbody').on({
    mouseenter: function () {
      var href = $(this).attr('href')
      $('.hover-image').attr('src', href).show()
      return false
    },
    mouseleave: function () {
      $('.hover-image').hide()
      return false
    }
  }, 'a.images')

  // disable editing when item has already been verified
  $('.link-actions.reset').each(function () {
    var parent = $(this).parent().parent()
    parent.find('input, select').attr('disabled', 'disabled').css('background', '#efeeee')
    parent.find('a.change-related, a.add-related').hide()
  })

  // the disabled lines should be enabled before saving request
  // to avoid form validation errors
  $('input[type=submit][value=Save]').on('click', function () {
    $('tr input:not([type=&quot;checkbox&quot;]):disabled').removeAttr('disabled')
  })

  // ajax request for removing barcode/tmall_id/jd_id/yhd_id
  $('td').on('click', '.ui.mini.button.inline', function () {
    var that = $(this)
    // get desired parameters

    $.ajax({
      url: '/api/path/to/remove/relation',
      type: 'POST',
      data: {
        // parameters
      },
      success: function (status) {
        console.log(status)
      },
      error: function (XMLHttpRequest, textStatus, errorThrown) {
        console.log(XMLHttpRequest.responseText)
      }
    })
  })

  // ajax requests for item operation actions
  $('.link-actions').click(function () {
    var that = $(this)
    // get desired parameters

    $.ajax({
      // pass
    })
  })

  // searching for categories using ajax requests
  $('input.search[name=&quot;action_category&quot;]').on('input', _.debounce(function () {
    var keyword = $(this).val();
    var regular = /^[0-9A-Za-z\u4e00-\u9fa5]{3,}$/
    if (keyword === String(keyword.match(regular))) {
      $.ajax({
        url: '/api/path/to/category/search?keyword=' + keyword,
        type: 'GET',
        success: function (data) {
          if (data.code === 0) {
            $('.menu').children().remove()
            for (var i = 0; i &lt; data.results.length; i++) {
              var item = '&lt;div class=&quot;item&quot; data-value=' + data.results[i].code + '&gt;'
                + data.results[i].name + '&lt;/div&gt;'
              $('.menu').append(item)
            }
            $('.menu').show()
          } else {
            alert(data)
          }
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
          alert(XMLHttpRequest.responseText)
        }
      })
    }
  }, 800))

  // category selection items click events
  $('.menu').on('click', '.item', function (e) {
    e.stopPropagation()
    $('input.search').val($(this).data('value'))
    $('.menu').hide()
  })
}
&lt;/script&gt;
{% endblock %}

&lt;!-- show pagination on both top and bottom --&gt;
{% block result_list %}
    {% block pagination %} {{ block.super }} {% endblock %}
    {{ block.super }}
{% endblock %}
</code></pre>

<p>Admin代码：</p>

<pre><code class="language-python">from django.db import models
from django.contrib import admin
from django.contrib.postgres.fields import ArrayField


class StdItemStatus(object):
    NEW = 'new'
    PENDING_REVIEW = 'pending_review'
    HALF_REVIEW = 'half_review'
    HUMAN_VERIFIED = 'human_verified'
    AUTO_VERIFIED = 'auto_verified'
    DELETED = 'deleted'
    NA = 'na'

    CHOICES = [
        (NEW, '新增标品'),
        (PENDING_REVIEW, '待审核'),
        (HALF_REVIEW, '半审核'),
        (HUMAN_VERIFIED, '已通过人工审核'),
        (AUTO_VERIFIED, '已通过自动审核'),
        (DELETED, '已删除'),
        (NA, '不处理'),
    ]
    


class Item(models.Model):
    # ...
    barcodes = ArrayField(
    models.TextField(), verbose_name='商品条码', null=True, blank=True)
    status = models.CharField(
        verbose_name='状态', max_length=20,
        default=StdItemStatus.NEW, choices=StdItemStatus.CHOICES)

    @property
    def is_verified(self):
        return self.status in (
            StdItemStatus.HUMAN_VERIFIED, StdItemStatus.AUTO_VERIFIED,
            StdItemStatus.DELETED, StdItemStatus.NA,
        )


def images_html(item_obj):
    from os.path import basename
    images = item_obj.images or []
    html = '&lt;br&gt;'.join(map(
        lambda url:
            '&lt;a class=&quot;images&quot; href=&quot;{url}&quot; target=&quot;_blank&quot;&gt;{name}&lt;/a&gt;'
            .format(url=url, name=basename(url)[:8]),
        images
    ))
    return html or '--'


def barcodes_html(item_obj):
    barcodes = item_obj.barcodes or []
    if item_obj.is_verified:
        html = '&lt;br&gt;'.join(map(
            lambda bc: '&lt;span&gt;{}&lt;/span&gt;'.format(bc),
            barcodes
        ))
    else:
        html = '&lt;br&gt;'.join(map(
            lambda bc: '&lt;span&gt;{}&lt;/span&gt;&lt;span class=&quot;mini ui button inline&quot;&gt;X&lt;/span&gt;',
            barcodes
        ))
        html += '&lt;br&gt;&lt;span class=&quot;tiny ui button&quot;&gt;添加&lt;/span&gt;'
    return html or '--'
barcodes_html.allow_tags = True
barcodes_html.short_description = '商品条码'


def operation_links(item_obj):
    if not item_obj.is_verified:
        edit = '&lt;a href=&quot;/admin/app/item/{id}&quot; target=&quot;_blank&quot;&gt;修改&lt;/a&gt;'.format(id=item_obj.id)
        verify = '&lt;a class=&quot;link-actions verify&quot; data-action=&quot;verify&quot; href=&quot;javascript:&quot;&gt;通过&lt;/a&gt;'
        remove = '&lt;a class=&quot;link-actions remove&quot; data-action=&quot;delete&quot; href=&quot;javascript:&quot;&gt;删除&lt;/a&gt;'
        return '&lt;br&gt;'.join([edit, verify, remove])
    else:
        reset = '&lt;a class=&quot;link-actions reset&quot; data-action=&quot;reset&quot; href=&quot;javascript:&quot;&gt;重置状态&lt;/a&gt;'
        return reset
operation_links.allow_tags = True
operation_links.short_description = '审核操作'


class ItemAdmin(admin.ModelAdmin):
    # ...
    list_display = [images_html, barcodes_html, operation_links, ]
    list_display_links = None
    list_per_page = 5

    change_list_template = 'app/admin/item_change_list.html'
</code></pre>

<h2 id="其他技巧">其他技巧</h2>

<h3 id="事务控制">事务控制</h3>

<p>其他适用场景：订单相关操作，运营操作日志。</p>

<pre><code class="language-python">from django.db import models, transaction
from django.contrib.postgres.fields import ArrayField


class Item(models.Model):
    barcodes = ArrayField(
        models.TextField(), verbose_name='国际条码', null=True, blank=True)
    tmall_ids = ArrayField(
        models.TextField(), verbose_name='天猫IDs', null=True, blank=True)
    jd_ids = ArrayField(
        models.TextField(), verbose_name='京东IDs', null=True, blank=True)
    yhd_ids = ArrayField(
        models.TextField(), verbose_name='一号店IDs', null=True, blank=True)

    def fix_m2m_conflict(self, conflict_fields):
        # fix conflicts between different items
        # in case of un-fixable errors, raise exceptions
        pass

    def save_relations(self, related_fields):
        # the related barcode, tmall/jd/yhd items should be saved
        # together with the item
        pass

    def save(self, force_insert=False, force_update=False, using=None,
             update_fields=None):
        # ...
        conflict_fields = []
        related_fields = []

        try:
            # all success or all fail
            with transaction.atomic():
                self.fix_m2m_conflict(conflict_fields)
                self.save_relations(related_fields)
                super(Item, self).save(force_insert, force_update, using, update_fields)
        except Exception as err:
            # NOTE: exceptions should be handled outside the transaction context
            pass
</code></pre>

<h3 id="自动注册admin类">自动注册Admin类</h3>

<pre><code class="language-python">from django.contrib import admin

from .models import *

# ModelAdmin classes definitions

# register all admin models which end with &quot;Admin&quot;
_locals = locals()
_obj_name = _obj = _m = None
for _obj_name, _obj in _locals.items():
    if (_obj_name.endswith('Admin') and
            issubclass(_obj, admin.ModelAdmin) and
            _obj is not admin.ModelAdmin):
        _m = _locals[_obj_name.replace('Admin', '')]
        admin.site.register(_m, _obj)
del _locals, _obj_name, _obj, _m
</code></pre>

<h3 id="在后台界面查看操作日志">在后台界面查看操作日志</h3>

<pre><code class="language-python">from django.contrib import admin
from django.contrib.admin.models import LogEntry


class LogEntryAdmin(admin.ModelAdmin):
    &quot;&quot;&quot;
    Admin of the history/log table for view only purpose.
    &quot;&quot;&quot;
    list_display = [
        'action_time', 'user', 'content_type', 'object_id', 'object_repr',
        'action_flag', 'change_message']
    readonly_fields = [
        'user', 'content_type', 'object_id', 'object_repr', 'action_flag',
        'change_message']
    list_filter = ['action_time', 'user', 'content_type']
    ordering = ['-action_time']
    list_display_links = None
    actions = None

    # We don't want people changing this historical record

    def has_add_permission(self, request):
        return False

    def has_delete_permission(self, request, obj=None):
        return False

    def save_model(self, request, obj, form, change):
        from django.core.exceptions import SuspiciousOperation
        raise SuspiciousOperation('log entry should not be changed')


admin.site.register(LogEntry, LogEntryAdmin)
</code></pre>

  </div>
  
</div>
<div class="more-posts">
  <h2><a href="/post/">&gt;&gt;&gt;&gt;</a></h2>
</div>
</div>

</body>
</html>
