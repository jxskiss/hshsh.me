<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Ubuntu on hshsh&#39;s little site</title>
    <link>http://hshsh.me/tags/ubuntu/index.xml</link>
    <description>Recent content in Ubuntu on hshsh&#39;s little site</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <atom:link href="http://hshsh.me/tags/ubuntu/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Ubuntu14.04上DNS引发的血案</title>
      <link>http://hshsh.me/post/2016-08-09-ubuntu-14.04-dnsmasq/</link>
      <pubDate>Tue, 09 Aug 2016 11:03:30 +0800</pubDate>
      
      <guid>http://hshsh.me/post/2016-08-09-ubuntu-14.04-dnsmasq/</guid>
      <description>&lt;p&gt;作为技术备忘，为了纪念为此死去的千千万万脑细胞，先说问题：&lt;/p&gt;

&lt;p&gt;公司搬家后，一台工作站上的爬虫程序突然莫名其妙的变慢，从一天20多万条数据萎缩到了14W-20W条不稳定，因为新办公室里所有部门共用一条网线，起初还以为是网络拥挤，属于正常情况，后来居然夸张的变成了每天3W条数据，经过跟踪发现这个爬虫全天候不分时间段的慢，这就很不对了。然后开始一系列的排查。&lt;/p&gt;

&lt;p&gt;后来把爬虫里面用域名访问的代码改成使用IP地址访问，发现速度连接速度不慢，但是一使用域名就变龟速了，很明显域名解析出问题了，作为临时方案，我居然手写了一段IP地址缓存的代码，:(&amp;lt;&lt;/p&gt;

&lt;p&gt;吐槽一下：Ubuntu系统配置DNS一点都不方便！！&lt;/p&gt;

&lt;p&gt;发现工作站上的DNS服务器被配置成了8.8.8.8，然而这段时间Google的DNS抽风了，经常连接不上，所以解决办法就很简单了。&lt;/p&gt;

&lt;p&gt;研究配置DNS的过程中，被灌输了一堆新名词：dnsmasq, resolv.conf, NetworkManager, resolvconf &amp;hellip;&lt;/p&gt;

&lt;p&gt;没看全部的文档，根据查阅的部分资料，Ubuntu的DNS机制大概是这样的：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;NetworkManager管理DNS配置，图形界面“编辑连接”弹出来的就是这货，这里配置的DNS存储在&lt;code&gt;/run/resolvconf/interface/NetworkManager&lt;/code&gt;文件中。&lt;/li&gt;
&lt;li&gt;系统范围DNS的基本配置在&lt;code&gt;/etc/resolvconf/resolv.conf.d/&lt;/code&gt;这个目录下面，这里有三个文件：&lt;code&gt;base&lt;/code&gt;中是基本配置，系统动态生成&lt;code&gt;resolv.conf&lt;/code&gt;文件时要包含的内容；&lt;code&gt;head&lt;/code&gt;也是要包含在&lt;code&gt;resolv.conf&lt;/code&gt;文件中的，里面主要包含一些说明，比如不要修改我会被覆盖之类的；&lt;code&gt;tail&lt;/code&gt;里是要追加到动态生成的&lt;code&gt;resolv.conf&lt;/code&gt;文件末尾的内容。&lt;/li&gt;
&lt;li&gt;从Ubuntu 12.04开始，系统默认都会安装一个阉割版的dnsmasq服务（dnsmasq-base包，不是dnsmasq包），主要是为了解决DNS和VPN之间的什么什么暧昧问题的，监听在127.0.1.1:53地址上，系统DNS请求都会发到这个监听地址上。&lt;/li&gt;
&lt;li&gt;系统启动或者执行&lt;code&gt;resolvconf -u&lt;/code&gt;命令的时候，会根据配置动态生成DNS配置文件&lt;code&gt;/ete/resolv.conf&lt;/code&gt;。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这个理解必然是不全面的，甚至有些完全就是错的，留待下次再搞DNS问题的时候研究吧。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;相关的解决方法&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;安装完整功能的Dnsmasq：&lt;code&gt;sudo apt-get install dnsmasq&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;配置Dnsmasq上游DNS服务器和本地监听地址，修改&lt;code&gt;/etc/dnsmasq.conf&lt;/code&gt;文件：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-conf&#34;&gt;listen-address=127.0.0.1,127.0.1.1
resolv-file=/etc/resolv.dnsmasq
conf-dir=/etc/dnsmasq.d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;/etc/resolv.dnsmasq&lt;/code&gt;文件里面写上游DNS服务器地址：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-conf&#34;&gt;nameserver 114.114.114.114
nameserver 223.5.5.5
nameserver 114.114.115.115
nameserver 223.6.6.6
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;其他dnsmasq配置自由发挥就好啦～&lt;/p&gt;

&lt;p&gt;修改系统DNS解析配置&lt;code&gt;/etc/resolvconf/resolv.conf.d/base&lt;/code&gt;：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-conf&#34;&gt;nameserver 127.0.0.1
nameserver 114.114.114.114
nameserver 223.5.5.5
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;然后启动dnsmasq服务：&lt;code&gt;sudo service dnsmasq restart&lt;/code&gt;，更新DNS动态配置：&lt;code&gt;sudo resolvconf -u&lt;/code&gt;。&lt;/p&gt;

&lt;p&gt;以上步骤&lt;strong&gt;可能&lt;/strong&gt;就解决问题了，也可能还会有问题，也可能会引入新的问题，比如参考资料4中提到的系统启动时候服务启动顺序的问题～～&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Dnsmasq扩展阅读&lt;/strong&gt;：&lt;/p&gt;

&lt;p&gt;Dnsmasq提供DNS缓存和DHCP服务功能。作为域名解析服务器(DNS)，dnsmasq可以通过缓存DNS请求来提高对访问过的网址的连接速度。作为DHCP服务器，dnsmasq可以用于为局域网电脑分配内网ip地址和提供路由。DNS和DHCP两个功能可以同时或分别单独实现。dnsmasq轻量且易配置，适用于个人用户或少于50台主机的网络。此外它还自带了一个PXE服务器。&lt;a href=&#34;https://wiki.archlinux.org/index.php/Dnsmasq&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;不使用Dnsmasq直接设置系统的DNS服务器&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;修改&lt;code&gt;/etc/resolvconf/resolv.conf.d/base&lt;/code&gt;文件中DNS配置：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-conf&#34;&gt;nameserver 114.114.114.114
nameserver 223.5.5.5
nameserver 114.114.115.115
nameserver 223.6.6.6
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;参考资料&lt;/strong&gt;：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;http://wiki.ubuntu.org.cn/%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0DNS%E5%8A%A0%E9%80%9F%E7%BD%91%E7%BB%9C%E8%AE%BF%E9%97%AE&#34;&gt;使用本地DNS加速网络访问&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://unix.stackexchange.com/questions/128220/how-do-i-set-my-dns-when-resolv-conf-is-being-overwritten&#34;&gt;How do I set my DNS when resolv.conf is being overwritten?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://superuser.com/questions/681993/using-dnsmasq-with-networkmanager&#34;&gt;Using dnsmasq with NetworkManager&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://gist.github.com/magnetikonline/6236150&#34;&gt;Using Dnsmasq with Ubuntu for VM web application testing&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
    </item>
    
    <item>
      <title>Ubuntu 14.04 使用阿里云源</title>
      <link>http://hshsh.me/post/2016-07-30-using-aliyun-mirror-for-ubuntu-14.04/</link>
      <pubDate>Sat, 30 Jul 2016 07:20:00 +0800</pubDate>
      
      <guid>http://hshsh.me/post/2016-07-30-using-aliyun-mirror-for-ubuntu-14.04/</guid>
      <description>&lt;p&gt;Ubuntu的官方源也是慢的不行不行的，怎么办？换阿里云的源，速度杠杠的！&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak  # 备份
sudo vim /etc/apt/sources.list  # 修改配置
sudo apt-get clean &amp;amp;&amp;amp; sudo apt-get update  # 更新列表
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;修改源配置如下：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-txt&#34;&gt;deb http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse

## Uncomment the following two lines to add software from Canonical&#39;s
## &#39;partner&#39; repository.
## This software is not part of Ubuntu, but is offered by Canonical and the
## respective vendors as a service to Ubuntu users.
# deb http://archive.canonical.com/ubuntu trusty partner
# deb-src http://archive.canonical.com/ubuntu trusty partner

## This software is not part of Ubuntu, but is offered by third-party
## developers who want to ship their latest software.
deb http://extras.ubuntu.com/ubuntu trusty main
deb-src http://extras.ubuntu.com/ubuntu trusty main
deb http://packagecloud.io/grafana/testing/debian/ wheezy main
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Ubuntu &amp; Linux 常用命令笔记</title>
      <link>http://hshsh.me/post/2016-04-27-ubuntu-linux-shell-commands-notes/</link>
      <pubDate>Wed, 27 Apr 2016 12:00:00 +0800</pubDate>
      
      <guid>http://hshsh.me/post/2016-04-27-ubuntu-linux-shell-commands-notes/</guid>
      <description>

&lt;h2 id=&#34;系统配置&#34;&gt;系统配置&lt;/h2&gt;

&lt;h3 id=&#34;安装-oracle-jdk&#34;&gt;安装 Oracle JDK&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ sudo add-apt-repository ppa:webupd8team/java
$ sudo apt-get update
$ sudo apt-get install oracle-java8-installer
$ sudo apt-get install oracle-java8-set-default
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;永久性修改系统dns&#34;&gt;永久性修改系统DNS&lt;/h3&gt;

&lt;p&gt;编辑&lt;code&gt;/etc/network/interfaces&lt;/code&gt;文件，在最后添加一行：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-conf&#34;&gt;dns-nameservers 8.8.8.8 8.8.4.4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;或者可以修改&lt;code&gt;/etc/resolvconf/resolv.conf.d/base&lt;/code&gt;文件，默认为空，在其中插入：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-conf&#34;&gt;nameserver 8.8.8.8
nameserver 8.8.4.4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;如果有多个DNS，就每行添加一个。&lt;/p&gt;

&lt;p&gt;NOTE：亲测，以上设置，需要重启系统后生效！&lt;/p&gt;

&lt;h2 id=&#34;常用命令行工具&#34;&gt;常用命令行工具&lt;/h2&gt;

&lt;h3 id=&#34;查看进程&#34;&gt;查看进程&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ ps ax
$ ps aux
$ ps ax | less
$ ps ax | grep ...
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;查看端口&#34;&gt;查看端口&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ netstat -tap | grep ...
$ netstat -na | grep ...
$ ss -tln | grep ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;查看指定进程占用的端口号：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ ps -ef | grep &amp;quot;process name&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;根据进程ID查看招用端口号：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;# redhat
$ netstat -nltp | grep pid
# ubuntu
$ netstat -anp | grep pid
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;查看占用某个端口的进程：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ lsof -i:port
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;监控日志文件&#34;&gt;监控日志文件&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ tail -f /path/to/file.log
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;重启-x-server&#34;&gt;重启 X Server&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ cat /etc/X11/default-display-manager
$ sudo restart {DISPLAY_MANAGER}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;输出重定向&#34;&gt;输出重定向&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ cat foo &amp;gt; foo.txt  # 重定向标准输出到文件
$ cat foo 2&amp;gt; foo.txt  # 重定向错误输出到文件
$ cat foo 2&amp;gt;&amp;amp;1  # 重定向错误输出到标准输出
$ cat foo &amp;gt; foo.txt 2&amp;gt;&amp;amp;1  # 重定向标准输出和错误输出到文件
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;如果要写入的文件权限不够，可以这样（&lt;code&gt;-a&lt;/code&gt;选项表示追加内容到文件）：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ sudo sh -c &amp;quot;echo &#39;xxx&#39;&amp;quot; &amp;gt; /path/to/somefile
$ echo &#39;xxx&#39; | sudo tee -a /path/to/somefile
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>XtraBackup热备份MySQL主从同步笔记</title>
      <link>http://hshsh.me/post/2016-04-26-mysql-hot-backup-with-xtrabackup/</link>
      <pubDate>Tue, 26 Apr 2016 18:30:00 +0800</pubDate>
      
      <guid>http://hshsh.me/post/2016-04-26-mysql-hot-backup-with-xtrabackup/</guid>
      <description>

&lt;p&gt;公司的MySQL数据库单实例裸跑了一个多月，今天终于做了主从同步，暂时主要起备份作用，庆幸这段时间没有发生意外。&lt;/p&gt;

&lt;p&gt;先说主要的参考资料，强烈推荐阅读：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://wsgzao.github.io/post/xtrabackup/&#34;&gt;XtraBackup不停机不锁表搭建MySQL主从同步实践&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://seanlook.com/2015/12/14/mysql-replicas/&#34;&gt;使用 Xtrabackup 在线对MySQL做主从复制&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://segmentfault.com/a/1190000002575399&#34;&gt;通过XtraBackup实现不停机不锁表搭建主从同步&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;更新历史&lt;/strong&gt;:&lt;/p&gt;

&lt;p&gt;2016-04-26: 初稿.&lt;/p&gt;

&lt;p&gt;2016-12-19:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;修复 innobackupex 命令错误: &amp;ldquo;xtrabackup: Error: &amp;ndash;defaults-file must be specified first on the command line&amp;rdquo;.&lt;/li&gt;
&lt;li&gt;添加 &amp;ldquo;主从复制心跳和连接超时&amp;rdquo; 内容.&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;简介&#34;&gt;简介&lt;/h2&gt;

&lt;p&gt;转载一下主从同步和XtraBackup的简介：&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;MySQL主从同步原理&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;MySQL主从同步是在MySQL主从复制(Master-Slave Replication)基础上实现的，通过设置在Master MySQL上的binlog(使其处于打开状态)，Slave MySQL上通过一个I/O线程从Master MySQL上读取binlog，然后传输到Slave MySQL的中继日志中，然后Slave MySQL的SQL线程从中继日志中读取中继日志，然后应用到Slave MySQL的数据库中。这样实现了主从数据同步功能。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;XtraBackup备份原理&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;innobackupex在后台线程不断追踪InnoDB的日志文件，然后复制InnoDB的数据文件。数据文件复制完成之后，日志的复制线程也会结束。这样就得到了不在同一时间点的数据副本和开始备份以后的事务日志。完成上面的步骤之后，就可以使用InnoDB崩溃恢复代码执行事务日志（redo log），以达到数据的一致性。&lt;/p&gt;

&lt;p&gt;备份分为两个过程：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;backup，备份阶段，追踪事务日志和复制数据文件（物理备份）。&lt;/li&gt;
&lt;li&gt;preparing，重放事务日志，使所有的数据处于同一个时间点，达到一致性状态。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;XtraBackup的优点&lt;/strong&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;可以快速可靠的完成数据备份（复制数据文件和追踪事务日志）&lt;/li&gt;
&lt;li&gt;数据备份过程中不会中断事务的处理（热备份）&lt;/li&gt;
&lt;li&gt;节约磁盘空间和网络带宽&lt;/li&gt;
&lt;li&gt;自动完成备份鉴定&lt;/li&gt;
&lt;li&gt;因更快的恢复时间而提高在线时间&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;操作笔记&#34;&gt;操作笔记&lt;/h2&gt;

&lt;p&gt;参考的两篇文章里面说的挺详细的，但是有部分命令和命令执行顺序写的不大明白，这里简单记录以下。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;完整的步骤&lt;/strong&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;主、从服务器上都搭好MySQL服务，从服务器上MySQL版本大于等于主服务器，最好完全一致&lt;/li&gt;
&lt;li&gt;在要做主从同步的服务器上分别安装XtraBackup&lt;/li&gt;
&lt;li&gt;如果从服务器上有MySQL实例，停掉服务，备份删除数据库内容，保留数据库目录&lt;/li&gt;
&lt;li&gt;配置主从服务器打开主从同步功能&lt;/li&gt;
&lt;li&gt;主服务器上执行备份&lt;/li&gt;
&lt;li&gt;传输备份文件到从服务器，并同步数据文件（apply-log）&lt;/li&gt;
&lt;li&gt;从服务器上恢复备份&lt;/li&gt;
&lt;li&gt;主服务器上授权同步帐号&lt;/li&gt;
&lt;li&gt;从服务器上设置MASTER并开启同步&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;完成，可以检查同步状态了！&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;具体操作过程&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;NOTE：以下命令以普通用户权限运行，如果需要ROOT权限，均使用&lt;code&gt;sudo&lt;/code&gt;执行。默认均使用Ubuntu发行版仓库中的MySQL，版本比较旧，如果使用官方发行版本，需要注意相关选项、目录等配置。&lt;/p&gt;

&lt;p&gt;一、主从服务器上搭建MySQL服务，并检查MySQL版本：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# master &amp;amp; slave
sudo apt-get install mysql-server
mysql --version
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;mysql  Ver 14.14 Distrib 5.5.49, for debian-linux-gnu (x86_64) using readline 6.3&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;二、主从服务器上分别安装XtraBackup，根据官方网站指导使用打包好的二进制，选择最新的稳定版2.4：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# master &amp;amp; slave
wget https://repo.percona.com/apt/percona-release_0.1-3.$(lsb_release -sc)_all.deb
sudo dpkg -i percona-release_0.1-3.$(lsb_release -sc)_all.deb
sudo apt-get update
sudo apt-get install percona-xtrabackup-24
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;三、停掉从服务器上MySQL服务，备份原有数据库，并删除原有数据库内容：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysqldump -u$USER -p$PASSWORD -h127.0.0.1 -P3306 --routines \
  --default-character-set=utf8 --locak-all-tables --add-drop-database -A \
  db.all.sql
sudo service mysql stop
sudo cd /var/lib/mysql
# 下面这句千万别打错了，后果会很严重
sudo rm -rf ./*
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;四、配置MySQL打开主从同步功能&lt;/p&gt;

&lt;p&gt;主服务器上编辑&lt;code&gt;/etc/mysql/my.conf&lt;/code&gt;文件：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-conf&#34;&gt;[mysqld]
# 注意主从之间的server-id不能相同
server-id    = 1
log_bin      = /var/log/mysql/mysql-bin.log
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;如果主服务器上MySQL是已经上线的系统，需要重启一下（实测&lt;code&gt;/etc/init.d/mysql reload&lt;/code&gt;不起作用）：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo service mysql restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;从服务器上编辑&lt;code&gt;/etc/mysql/my.conf&lt;/code&gt;文件：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-conf&#34;&gt;[mysqld]
# 注意主从之间的server-id不能相同
server-id    = 2
# 最好设置从服务器为只读
# 注意：即使这里设置了只读，使用具有super权限的用户登录，也还是可以做写操作的
read_only    = ON
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;查询主从服务器状态：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysql -u USER -p PASSWD -e &amp;quot;show global variables like &#39;server-id&#39;;&amp;quot;
    +---------------+-------+
    | Variable_name | Value |
    +---------------+-------+
    | server_id     | 1     |
    +---------------+-------+

mysql -u USER -p PASSWD -e &amp;quot;show global variables like &#39;log_bin&#39;;&amp;quot;
    +---------------+-------+
    | Variable_name | Value |
    +---------------+-------+
    | log_bin       | ON    |
    +---------------+-------+
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;五、主服务器上执行备份操作&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo innobackupex --defaults-file=/etc/mysql/my.cnf --user=USER --password \
  --parallel=4 /tmp/mybackup
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;命令输出的最后几行通常类似这样：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;innobackupex: Backup created in directory &#39;/tmp/mybackup/2016-04-26_17-41-51&#39;
innobackupex: MySQL binlog position: filename &#39;mysql-bin.000003&#39;, position 1946
111225 00:00:53 innobackupex: completed OK!
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;命令执行完在&lt;code&gt;/tmp/mybackup&lt;/code&gt;目录下生成的&lt;code&gt;2016-04-26_17-41-51&lt;/code&gt;目录，里面存储的是备份的数据，下一步要传输到从服务器上的即是这个文件夹。&lt;/p&gt;

&lt;p&gt;输出中的&lt;code&gt;MySQL binlog position: filename &#39;mysql-bin.000003&#39;, position 1946&lt;/code&gt;里面的两个数字，要记录以下，后面恢复到从服务器上的时候要用到。&lt;/p&gt;

&lt;p&gt;六、传输并同步备份数据&lt;/p&gt;

&lt;p&gt;读取备份数据需要ROOT权限，下面的命令需要使用sudo执行。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mkdir /tmp/mybackup
sudo scp -r /tmp/mybackup/2016-04-26_17-44-49 USER@SLAVE:/tmp/mybackup/2016-04-26
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;在从服务器上执行：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo innobackupex --apply-log /tmp/mybackup/2016-04-26
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;七、从服务器上恢复备份数据&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# 恢复数据
sudo innobackupex --defaults-file=/etc/mysql/my.cnf --user=USER --password \
  --copy-back /tmp/mybackup/2016-04-26/
# 需要恢复权限给mysql
sudo chown -R mysql:mysql /var/lib/mysql
# 启动MySQL
sudo service mysql start
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;NOTE: 如果从数据库存在多个MySQL，执行命令有所不同，请另行查阅相关资料。&lt;/p&gt;

&lt;p&gt;八、主服务器上授权同步帐号&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sql&#34;&gt;mysql -u USER -p PASSWD -h HOST -P PORT
&amp;gt; grant replication slave on *.* to &#39;slave&#39;@&#39;10.10.16.24&#39; identified by &#39;slave_passport&#39;;
&amp;gt; flush privileges;
&amp;gt;
&amp;gt; select distinct concat(&#39;User: &#39;&#39;&#39;,user,&#39;&#39;&#39;@&#39;&#39;&#39;,host,&#39;&#39;&#39;;&#39;) as query from mysql.user;
&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;最后一条语句查询当前数据库中的用户信息，检查&lt;code&gt;slave_passport&lt;/code&gt;是否在其中。&lt;/p&gt;

&lt;p&gt;九、配置从服务器开启同步&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sql&#34;&gt;mysql -u USER -p PASSWD -h HOST -p PORT
&amp;gt; change master to
&amp;gt; master_host = &#39;10.10.16.51&#39;,
&amp;gt; master_user = &#39;slave&#39;,
&amp;gt; master_password = &#39;slave_password&#39;,
&amp;gt; master_port = 3306,
&amp;gt; master_log_file = &#39;mysql-bin.000003&#39;,
&amp;gt; master_log_pos = 1946;
&amp;gt;
&amp;gt; start slave;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;查看主库同步状态：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysql -u USER -p PASSWD -h MASTER_HOST -P MASTER_PORT \
  -e &amp;quot;show master status \G;&amp;quot;
mysql -u USER -p PASSWD -h SLAVE_HOST -P SLAVE_PORT \
  -e &amp;quot;show processlist \G;&amp;quot; | grep -i &#39;master&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;检查第二条命令输出是否类似“State: Master has sent all binlog to slave; waiting for binlog to be updated”这样。&lt;/p&gt;

&lt;p&gt;查看从库同步状态：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysql -u USER -p PASSWD -h SLAVE_HOST -P SLAVE_PORT \
  -e &amp;quot;show slave status \G;&amp;quot;
mysql -u USER -p PASSWD -h SLAVE_HOST -P SLAVE_PORT \
  -e &amp;quot;show processlist \G;&amp;quot; | egrep -i &#39;(master|slave)&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;检查命令输出是否包含类似下面这样的语句：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Slave_IO_State: Waiting for master to send event
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it

State: Waiting for master to send event
State: Slave has read all relay log; waiting for the slave I/O thread to update it
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;mysql主从切换&#34;&gt;MySQL主从切换&lt;/h2&gt;

&lt;p&gt;这里暂时还没有用到主从切换，不过参考资料&lt;a href=&#34;http://wsgzao.github.io/post/xtrabackup/&#34;&gt;XtraBackup不停机不锁表搭建MySQL主从同步实践&lt;/a&gt;中有写到主从切换的过程，复制粘贴一下以后好找：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sql&#34;&gt;#查看主库状态
show processlist;
Master has sent all binlog to slave; waiting for binlog to be updated
show master status \G

#从库停止 IO_THREAD 线程
stop slave IO_THREAD;
show processlist;
Slave has read all relay log; waiting for the slave I/O thread to update it
show slave status \G

#从库切换为主库
stop slave;
reset master;
reset slave all;
show master status \G

#激活帐户
SELECT DISTINCT CONCAT(&#39;User: &#39;&#39;&#39;,user,&#39;&#39;&#39;@&#39;&#39;&#39;,host,&#39;&#39;&#39;;&#39;) AS query FROM mysql.user;
GRANT REPLICATION SLAVE ON *.* TO &#39;slave_passport&#39;@&#39;10.10.16.51&#39; IDENTIFIED BY &#39;slave_passport&#39;;
FLUSH PRIVILEGES;

#切换原有主库为从库
reset master;
reset slave all;

CHANGE MASTER TO
MASTER_HOST=&#39;10.10.16.24&#39;,
MASTER_USER=&#39;slave_passport&#39;,
MASTER_PASSWORD=&#39;slave_passport&#39;,
MASTER_PORT=3306,
MASTER_LOG_FILE=&#39;mysql-bin.000001&#39;,
MASTER_LOG_POS=804497686;

#检查主库
SHOW PROCESSLIST;
show master status \G

#启动从库
SHOW PROCESSLIST;
start slave;
show slave status \G
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;2016-12-19更新-主从复制心跳和连接超时&#34;&gt;2016-12-19更新: 主从复制心跳和连接超时&lt;/h2&gt;

&lt;p&gt;实际运行过程中, 由于没有专门的人做运维, 从服务器也只是起备份作用, 偶尔发现从服务器已经没有跟主服务器同步, 数据滞后了很长时间了, 估计是跟公司网络环境不大稳定有关系.&lt;/p&gt;

&lt;p&gt;在网上了解到MySQL 5.5以上版本的主从复制还有一个心跳功能, 参考这里: &lt;a href=&#34;http://blog.csdn.net/JesseYoung/article/details/42914577&#34;&gt;MySQL运维-主从复制心跳&lt;/a&gt;. 果断打开心跳功能.&lt;/p&gt;

&lt;p&gt;连接从服务器, 执行下面指令配置心跳周期和连接超时:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mysql&amp;gt; stop slave;
mysql&amp;gt; change master to master_heartbeat_period = 10;
mysql&amp;gt; set global slave_net_timeout = 25;
mysql&amp;gt; start slave;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;可以通过以下命令检查心跳状态:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mysql -uUSER -pPASSWORD -hHOST -PPORT -e &amp;quot;show status like &#39;slave%&#39;;&amp;quot;
    +----------------------------+--------+
    | Variable_name              | Value  |
    +----------------------------+--------+
    | Slave_heartbeat_period     | 10.000 |
    | Slave_last_heartbeat       |        |
    | Slave_open_temp_tables     | 0      |
    | Slave_received_heartbeats  | 0      |
    | Slave_retried_transactions | 0      |
    | Slave_running              | ON     |
    +----------------------------+--------+
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
  </channel>
</rss>